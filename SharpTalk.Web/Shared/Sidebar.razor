@using SharpTalk.Shared.DTOs
@using SharpTalk.Web.Services
@inject WorkspaceService WorkspaceService

<div class="sidebar">
    <div class="workspace-list">
        @if (Workspaces == null)
        {
             @for (int i = 0; i < 5; i++)
            {
                <div class="skeleton skeleton-icon"></div>
            }
        }
        else
        {
            @foreach (var workspace in Workspaces)
            {
                <div class="workspace-item @(ActiveWorkspaceId == workspace.Id ? "active" : "")" 
                     title="@workspace.Name"
                     draggable="true"
                     @ondragstart="() => HandleDragStart(workspace)"
                     @ondrop="() => HandleDrop(workspace)"
                     @ondragover="HandleDragOver"
                     @ondragover:preventDefault
                     @onclick="() => SelectWorkspace(workspace.Id)">
                    <span class="workspace-icon">@workspace.Name.Substring(0, 1).ToUpper()</span>
                </div>
            }
            
            <div class="workspace-item dms-item @(ActiveWorkspaceId == -2 ? "active" : "")" 
                 title="Direct Messages"
                 @onclick="() => SelectWorkspace(-2)">
                <span class="workspace-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                    </svg>
                </span>
            </div>

            <div class="workspace-item home-item @(ActiveWorkspaceId == -1 ? "active" : "")" 
                 title="Home"
                 @onclick="() => SelectWorkspace(-1)">
                <span class="workspace-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                </span>
            </div>

            <div class="workspace-item add-workspace" @onclick="OpenCreateModal">
                <span class="workspace-icon">+</span>
            </div>
        }
    </div>
</div>

<CreateWorkspaceModal @ref="CreateModal" OnWorkspaceCreated="OnWorkspaceCreated" />

@code {
    [Parameter]
    public List<WorkspaceDto>? Workspaces { get; set; }

    [Parameter]
    public int ActiveWorkspaceId { get; set; }

    [Parameter]
    public EventCallback<int> OnWorkspaceSelected { get; set; }
    
    [Parameter]
    public EventCallback<List<WorkspaceDto>> OnWorkspacesReordered { get; set; }

    [Parameter]
    public EventCallback<WorkspaceDto> OnWorkspaceCreatedCallback { get; set; }

    private CreateWorkspaceModal? CreateModal;
    private WorkspaceDto? dragedItem;

    private async Task SelectWorkspace(int id)
    {
        await OnWorkspaceSelected.InvokeAsync(id);
    }

    private void OpenCreateModal()
    {
        CreateModal?.Open();
    }

    private async Task OnWorkspaceCreated(WorkspaceDto newWorkspace)
    {
        await OnWorkspaceCreatedCallback.InvokeAsync(newWorkspace);
    }
    
    private void HandleDragStart(WorkspaceDto item)
    {
        dragedItem = item;
    }

    private void HandleDragOver(DragEventArgs e)
    {
        // allow drop
        e.DataTransfer.DropEffect = "move";
    }

    private async Task HandleDrop(WorkspaceDto targetItem)
    {
        if (dragedItem == null || Workspaces == null) return;
        
        var oldIndex = Workspaces.IndexOf(dragedItem);
        var newIndex = Workspaces.IndexOf(targetItem);
        
        if (oldIndex == -1 || newIndex == -1) return;
        
        // Swap or move?
        Workspaces.RemoveAt(oldIndex);
        Workspaces.Insert(newIndex, dragedItem);
        
        dragedItem = null;
        
        await OnWorkspacesReordered.InvokeAsync(Workspaces);
    }
}
