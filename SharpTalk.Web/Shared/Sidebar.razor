@using SharpTalk.Shared.DTOs
@using SharpTalk.Web.Services
@inject WorkspaceService WorkspaceService
@inject NavigationManager Navigation

<div class="sidebar">
    <div class="workspace-list">
        @if (Workspaces == null || !Workspaces.Any() && isLoading)
        {
            @for (int i = 0; i < 5; i++)
            {
                <div class="skeleton skeleton-icon"></div>
            }
        }
        else
        {
            @foreach (var workspace in Workspaces)
            {
                <div class="workspace-item @(selectedWorkspaceId == workspace.Id ? "active" : "")" title="@workspace.Name"
            @onclick="() => SelectWorkspace(workspace.Id)">
                    <span class="workspace-icon">@workspace.Name.Substring(0, 1).ToUpper()</span>
                </div>
            }
        }
        <div class="workspace-item add-workspace" @onclick="OpenCreateModal">
            <span class="workspace-icon">+</span>
        </div>
    </div>
</div>

<CreateWorkspaceModal @ref="CreateModal" OnWorkspaceCreated="OnWorkspaceCreated" />

@code {
    [Parameter]
    public EventCallback<WorkspaceDto> OnWorkspaceSelected { get; set; }

    private List<WorkspaceDto> Workspaces = new List<WorkspaceDto>();
    private CreateWorkspaceModal? CreateModal;
    private int selectedWorkspaceId;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadWorkspaces();
    }

    private async Task LoadWorkspaces()
    {
        try
        {
            isLoading = true;
            Workspaces = await WorkspaceService.GetMyWorkspacesAsync();
            isLoading = false;
            if (Workspaces.Any())
            {
                await SelectWorkspace(Workspaces.First().Id);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading workspaces: {ex.Message}");
            isLoading = false;
        }
    }

    private async Task SelectWorkspace(int id)
    {
        selectedWorkspaceId = id;
        var workspace = Workspaces.FirstOrDefault(w => w.Id == id);
        if (workspace != null)
        {
            await OnWorkspaceSelected.InvokeAsync(workspace);
        }
    }

    private void OpenCreateModal()
    {
        CreateModal?.Open();
    }

    private async Task OnWorkspaceCreated(WorkspaceDto newWorkspace)
    {
        Workspaces.Add(newWorkspace);
        await SelectWorkspace(newWorkspace.Id);
    }
}
