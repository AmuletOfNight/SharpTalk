@using SharpTalk.Shared.DTOs
@using SharpTalk.Shared.Enums
@using SharpTalk.Web.Services
@inject ChannelService ChannelService
@inject ChatService ChatService
@inject UrlUtilityService UrlUtilityService
@inject AuthenticationStateProvider AuthStateProvider
@using System.Security.Claims

<div class="channel-list">
    <div class="workspace-name-header">
        <h5>Direct Messages</h5>
        <div class="d-flex gap-1">
            <button class="btn btn-sm btn-link text-white p-0" @onclick="OpenStartGroupDMModal" title="Create Group DM">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
            </button>
            <button class="btn btn-sm btn-link text-white p-0" @onclick="OpenStartDMModal" title="New Direct Message">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                    stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
        </div>
    </div>

    <div class="p-2">
        <div class="form-group mb-2">
            <input type="text" class="form-control form-control-sm dm-search-input" placeholder="Find or start a conversation" />
        </div>
        
        <ul class="list-group list-group-flush">
             @foreach (var channel in Channels)
            {
                var isGroup = channel.Type == ChannelType.Group;
                 <li class="channel-item @(ActiveChannelId == channel.Id ? "active" : "")"
                @onclick="() => SelectChannel(channel)">
                    <div class="d-flex align-items-center w-100">
                     <div class="member-avatar-wrapper me-2">
                             @if (isGroup)
                             {
                                 <div class="group-dm-avatar">
                                     <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                         <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                         <circle cx="9" cy="7" r="4"></circle>
                                         <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                         <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                     </svg>
                                 </div>
                             }
                             else if (!string.IsNullOrEmpty(channel.AvatarUrl))
                             {
                                 <img src="@UrlUtilityService.GetAvatarUrl(channel.AvatarUrl, "s")"
                                      class="member-avatar-list @(channel.UserStatus.ToLower())"
                                      style="background-color: #5865f2;"
                                      alt="@channel.Name" />
                             }
                             else
                             {
                                 <div class="member-avatar-list @(channel.UserStatus.ToLower())" style="background-color: #5865f2; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                     @channel.Name.Substring(0, 1).ToUpper()
                                 </div>
                             }
                        </div>
                        <div class="d-flex flex-column" style="min-width: 0; flex: 1;">
                            <div class="d-flex align-items-center gap-1">
                                <span class="text-truncate fw-bold">@channel.Name</span>
                                @if (isGroup)
                                {
                                    <span class="badge bg-secondary" style="font-size: 0.65rem;">@channel.MemberCount</span>
                                }
                            </div>
                            @if (!string.IsNullOrEmpty(channel.Description))
                            {
                                 <small class="text-muted text-truncate">@channel.Description</small>
                            }
                        </div>
                    </div>
                </li>
            }
        </ul>
    </div>
</div>

<StartDirectMessageModal @ref="StartDMModal" WorkspaceId="0" OnChannelCreated="OnChannelCreated" />
<StartGroupDMModal @ref="StartGroupDMModal" WorkspaceId="0" OnGroupCreated="OnGroupCreated" />

@implements IDisposable

@code {
    [Parameter]
    public int ActiveChannelId { get; set; }

    [Parameter]
    public EventCallback<ChannelDto> OnChannelSelected { get; set; }

    private List<ChannelDto> Channels = new List<ChannelDto>();
    private StartDirectMessageModal? StartDMModal;
    private StartGroupDMModal? StartGroupDMModal;
    
    protected override async Task OnInitializedAsync()
    {
        ChatService.OnMessageReceived += HandleMessageReceived;
        ChatService.OnUserStatusChanged += HandleUserStatusChanged;
        await LoadDMs();
    }

    private async Task LoadDMs()
    {
        Channels = await ChannelService.GetDirectMessagesAsync();
    }

    public async Task RefreshDMs()
    {
        await LoadDMs();
        await InvokeAsync(StateHasChanged);
    }

    private void HandleMessageReceived(MessageDto message)
    {
        // Find if we have this channel in the list
        var channel = Channels.FirstOrDefault(c => c.Id == message.ChannelId);
        
        if (channel != null)
        {
            // Update description and move to top
            channel.Description = message.Content;
            
            // Move to top
            Channels.Remove(channel);
            Channels.Insert(0, channel);
            
            InvokeAsync(StateHasChanged);
        }
        else
        {
            // Channel not found in DMs list - could be a workspace channel or a new DM
            // For now, we only update existing DMs to avoid aggressive reloads
        }
    }

    private async void HandleUserStatusChanged(UserStatusDto status)
    {
        // Update status for any DM with this user
        var channel = Channels.FirstOrDefault(c => c.TargetUserId == status.UserId);
        if (channel != null)
        {
            channel.UserStatus = status.Status;
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task SelectChannel(ChannelDto channel)
    {
        await OnChannelSelected.InvokeAsync(channel);
    }

    private void OpenStartDMModal()
    {
        StartDMModal?.Open();
    }

    private void OpenStartGroupDMModal()
    {
        StartGroupDMModal?.Open();
    }

    private async Task OnChannelCreated(ChannelDto newChannel)
    {
        if (!Channels.Any(c => c.Id == newChannel.Id))
        {
            Channels.Insert(0, newChannel);
        }
        await SelectChannel(newChannel);
    }

    private async Task OnGroupCreated(ChannelDto newChannel)
    {
        if (!Channels.Any(c => c.Id == newChannel.Id))
        {
            Channels.Insert(0, newChannel);
        }
        await SelectChannel(newChannel);
    }
    
    public void Dispose()
    {
        ChatService.OnMessageReceived -= HandleMessageReceived;
        ChatService.OnUserStatusChanged -= HandleUserStatusChanged;
    }
}
