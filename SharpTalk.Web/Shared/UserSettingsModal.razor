@using SharpTalk.Shared.DTOs
@using SharpTalk.Web.Services
@inject UserService UserService
@inject UrlUtilityService UrlUtilityService
@inject IJSRuntime JSRuntime

@if (IsOpen)
{
    <div class="modal-overlay" @onclick="Close">
        <div class="modal-content user-settings-modal" @onclick:stopPropagation>
            <div class="modal-header">
                <h3>User Settings</h3>
                <button class="close-btn" @onclick="Close">Ã—</button>
            </div>
            
            <div class="modal-body">
                <!-- Avatar Section -->
                <div class="avatar-section">
                    <div class="avatar-container">
                        <img src="@(previewUrl ?? UrlUtilityService.GetAvatarUrl(CurrentUser?.AvatarUrl, "l"))"
                             class="avatar-preview @(selectedStatus.ToLower())"
                             alt="Profile Avatar" />
                        @if (isUploading)
                        {
                            <div class="avatar-loading">
                                <div class="spinner-small"></div>
                            </div>
                        }
                    </div>
                    <div class="avatar-actions">
                        <label class="btn-upload">
                            @(selectedFile == null ? "Select New Avatar" : "Change Selection")
                            <InputFile OnChange="HandleAvatarUpload" accept="image/jpeg,image/png,image/gif,image/webp" />
                        </label>
                        <small class="avatar-hint">JPG, PNG, GIF or WebP. Max 2MB.</small>
                    </div>

                    @if (isCropping)
                    {
                        <div class="cropper-section">
                            <div class="cropper-wrapper">
                                <cropper-canvas id="@cropperImageId" background>
                                    <cropper-image scalable translatable rotatable></cropper-image>
                                    <cropper-selection initial-coverage="0.5" outlined movable resizable aspect-ratio="1">
                                        <cropper-handle action="move" theme-color="rgba(255, 255, 255, 0.35)"></cropper-handle>
                                        <cropper-handle action="n-resize"></cropper-handle>
                                        <cropper-handle action="e-resize"></cropper-handle>
                                        <cropper-handle action="s-resize"></cropper-handle>
                                        <cropper-handle action="w-resize"></cropper-handle>
                                        <cropper-handle action="ne-resize"></cropper-handle>
                                        <cropper-handle action="nw-resize"></cropper-handle>
                                        <cropper-handle action="se-resize"></cropper-handle>
                                        <cropper-handle action="sw-resize"></cropper-handle>
                                    </cropper-selection>
                                </cropper-canvas>
                            </div>
                        </div>
                    }
                </div>

                <!-- Profile Info -->
                <div class="form-section">
                    <div class="form-group">
                        <label>Username</label>
                        <InputText @bind-Value="username" class="form-control" disabled />
                        <small class="form-hint">Username cannot be changed</small>
                    </div>

                    <div class="form-group">
                        <label>Email</label>
                        <InputText @bind-Value="email" class="form-control" disabled />
                        <small class="form-hint">Email cannot be changed</small>
                    </div>

                    <div class="form-group">
                        <label>Status</label>
                        <div class="status-options">
                            <button type="button" class="status-option @(selectedStatus == "Online" ? "active online" : "")" @onclick="SelectOnline">
                                <span class="status-dot online"></span>
                                Online
                            </button>
                            <button type="button" class="status-option @(selectedStatus == "Away" ? "active away" : "")" @onclick="SelectAway">
                                <span class="status-dot away"></span>
                                Away
                            </button>
                            <button type="button" class="status-option @(selectedStatus == "Offline" ? "active offline" : "")" @onclick="SelectOffline">
                                <span class="status-dot offline"></span>
                                Offline
                            </button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Preferences</label>
                        <div class="d-flex flex-column gap-2 mt-2">
                             <div class="form-check">
                                <input type="checkbox" id="chkStartOnHome" class="form-check-input" @bind="startOnHome" />
                                <label for="chkStartOnHome" class="form-check-label text-white">Start on Home View</label>
                            </div>
                            <div class="form-check">
                                <input type="checkbox" id="chkAutoOpen" class="form-check-input" @bind="autoOpenChannel" />
                                <label for="chkAutoOpen" class="form-check-label text-white">Automatically open last visited channel</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                @if (isCropping)
                {
                    <button type="button" class="btn btn-secondary" @onclick="CancelCrop">Cancel Selection</button>
                    <button type="button" class="btn btn-success" @onclick="ConfirmCrop">Confirm Selection</button>
                }
                else
                {
                    <button type="button" class="btn btn-secondary" @onclick="Close">Cancel</button>
                    <button type="button" class="btn btn-primary" @onclick="SaveSettings" disabled="@isSaving">
                        @if (isSaving)
                        {
                            <span class="spinner-small"></span>
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>Save Changes</span>
                        }
                    </button>
                }
            </div>
        </div>
    </div>
}

@code {
    private bool IsOpen = false;
    private UserInfo? CurrentUser;
    private string username = string.Empty;
    private string email = string.Empty;
    private string selectedStatus = "Online";
    private string? previewUrl;
    private bool isUploading = false;
    private bool isSaving = false;
    private bool isCropping = false;
    private IBrowserFile? selectedFile;
    private string? croppedBase64;
    private string cropperImageId = $"cropper-{Guid.NewGuid():N}";
    private bool startOnHome;
    private bool autoOpenChannel;

    public void Open()
    {
        LoadCurrentUser();
        IsOpen = true;
    }

    public void Close()
    {
        IsOpen = false;
        previewUrl = null;
        isCropping = false;
        selectedFile = null;
        _ = JSRuntime.InvokeVoidAsync("imageCropper.destroy");
    }

    private void CancelCrop()
    {
        isCropping = false;
        selectedFile = null;
        previewUrl = null;
        croppedBase64 = null;
        _ = JSRuntime.InvokeVoidAsync("imageCropper.destroy");
    }

    private async Task ConfirmCrop()
    {
        var croppedData = await JSRuntime.InvokeAsync<string>("imageCropper.getCroppedImage");
        if (!string.IsNullOrEmpty(croppedData))
        {
            croppedBase64 = croppedData;
            previewUrl = croppedData;
            isCropping = false;
            // Don't clear selectedFile, we need it for the name in SaveSettings
            await JSRuntime.InvokeVoidAsync("imageCropper.destroy");
        }
    }

    private async void LoadCurrentUser()
    {
        CurrentUser = await UserService.GetCurrentUserAsync();
        if (CurrentUser != null)
        {
            username = CurrentUser.Username;
            email = CurrentUser.Email;
            selectedStatus = CurrentUser.Status;
            startOnHome = CurrentUser.StartOnHome;
            autoOpenChannel = CurrentUser.AutoOpenLastChannel;
        }
        StateHasChanged();
    }

    private void SelectOnline() => selectedStatus = "Online";
    private void SelectAway() => selectedStatus = "Away";
    private void SelectOffline() => selectedStatus = "Offline";

    private async Task HandleAvatarUpload(InputFileChangeEventArgs e)
    {
        if (e.File == null) return;

        var file = e.File;
        
        // Validate file type
        var allowedTypes = new[] { "image/jpeg", "image/png", "image/gif", "image/webp" };
        if (!allowedTypes.Contains(file.ContentType.ToLower()))
        {
            return;
        }

        // Validate file size (max 2MB)
        const int maxFileSize = 2 * 1024 * 1024;
        if (file.Size > maxFileSize)
        {
            return;
        }

        selectedFile = file;
        isCropping = true;
        StateHasChanged();

        // Show preview and init cropper
        var memoryStream = new MemoryStream();
        await file.OpenReadStream(maxFileSize).CopyToAsync(memoryStream);
        var bytes = memoryStream.ToArray();
        var dataUrl = $"data:{file.ContentType};base64,{Convert.ToBase64String(bytes)}";
        
        // Need a small delay to ensure the DOM is updated with the new img tag
        await Task.Delay(100);
        await JSRuntime.InvokeVoidAsync("imageCropper.init", cropperImageId, dataUrl);
    }

    private async Task SaveSettings()
    {
        if (CurrentUser == null) return;

        isSaving = true;
        StateHasChanged();

        // Handle avatar upload if a file was selected and cropped
        if (selectedFile != null && !string.IsNullOrEmpty(croppedBase64))
        {
            var successUpload = await UserService.UploadAvatarFromBase64Async(croppedBase64, selectedFile.Name);
            if (successUpload)
            {
                selectedFile = null;
                croppedBase64 = null;
            }
        }

        var updatedUser = new UserInfo
        {
            Id = CurrentUser.Id,
            Username = CurrentUser.Username,
            Email = CurrentUser.Email,
            AvatarUrl = UserService.CurrentUser?.AvatarUrl ?? CurrentUser.AvatarUrl,
            Status = selectedStatus,
            StartOnHome = startOnHome,
            AutoOpenLastChannel = autoOpenChannel
        };

        var success = await UserService.UpdateUserInfoAsync(updatedUser);

        isSaving = false;
        if (success)
        {
            Close();
        }
        StateHasChanged();
    }

}
