@using SharpTalk.Shared.DTOs
@using SharpTalk.Shared.Enums
@using SharpTalk.Web.Services
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@implements IDisposable
@inject ChannelService ChannelService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ChatService ChatService
@inject WorkspaceService WorkspaceService
@inject UrlUtilityService UrlUtilityService

<div class="channel-list">
    <div class="workspace-name-header">
        <h5 title="@Workspace?.Name">@(Workspace?.Name ?? "Workspace")</h5>
        @if (IsOwner)
        {
            <div class="settings-trigger text-muted" title="Workspace Settings" @onclick="OpenWorkspaceSettings">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
            </div>
        }
    </div>

    <div class="sidebar-category">
        <h6>Channels</h6>
        @if (IsOwner)
        {
            <button class="btn btn-sm btn-link text-decoration-none p-0 text-muted" @onclick="OpenCreateModal"
            @onclick:stopPropagation="true" title="Create Channel">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
        }
    </div>

    <ul class="list-group list-group-flush mb-2">
        @if (isLoading)
        {
            @for (int i = 0; i < 3; i++)
            {
                <div class="skeleton skeleton-channel"></div>
            }
        }
        else
        {
            @foreach (var channel in Channels.Where(c => c.Type != ChannelType.Direct))
            {
                <li class="channel-item @(selectedChannelId == channel.Id ? "active" : "")"
            @onclick="() => SelectChannel(channel)">
                    <span class="channel-hash">@((channel.IsPrivate) ? "ðŸ”’" : "#")</span> @channel.Name
                </li>
            }
        }
    </ul>

    <!-- DMs moved to Global View -->

    <div class="sidebar-category mt-3">
        <h6>Members</h6>
    </div>
    <ul class="list-group list-group-flush">
        @foreach (var member in Members)
        {
            <li class="channel-item d-flex align-items-center mb-1 member-item justify-content-between" style="cursor: default;">
                <div class="d-flex align-items-center" style="min-width: 0;">
                    <div class="member-avatar-wrapper">
                        <img src="@UrlUtilityService.GetAvatarUrl(member.AvatarUrl, "s")" 
                             class="member-avatar-list @(member.Status.ToLower())" 
                             alt="@member.Username" />
                    </div>
                    <span class="text-truncate">@member.Username</span>
                </div>
                @if (member.UserId != _currentUserId)
                {
                    <button class="btn btn-sm btn-icon text-muted dm-btn" title="Message" @onclick="() => StartDM(member)">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                    </button>
                }
            </li>
        }
    </ul>
</div>

<CreateChannelModal @ref="CreateModal" WorkspaceId="@(Workspace?.Id ?? 0)" OnChannelCreated="OnChannelCreated" />
<WorkspaceSettingsModal @ref="SettingsModal" Workspace="Workspace" IsOwner="IsOwner" OnWorkspaceChanged="OnWorkspaceChanged" />

@code {
    [Parameter]
    public WorkspaceDto? Workspace { get; set; }

    [Parameter]
    public int ActiveChannelId { get; set; }

    [Parameter]
    public EventCallback<ChannelDto> OnChannelSelected { get; set; }

    private List<ChannelDto> Channels = new List<ChannelDto>();
    private List<UserStatusDto> Members = new List<UserStatusDto>();
    private CreateChannelModal? CreateModal;
    private WorkspaceSettingsModal? SettingsModal;
    private int selectedChannelId;
    private bool IsOwner;
    private int _lastWorkspaceId;
    private bool isLoading;
    private int _currentUserId;

    protected override async Task OnInitializedAsync()
    {
        ChatService.OnUserStatusChanged += HandleUserStatusChanged;
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userIdStr = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (int.TryParse(userIdStr, out int userId))
        {
            _currentUserId = userId;
        }
        await base.OnInitializedAsync();
    }
    
    // ... [Rest of methods seem largely fine, just adding OpenStartDMModal]

    protected override async Task OnParametersSetAsync()
    {
        if (Workspace != null)
        {
            if (Workspace.Id != _lastWorkspaceId)
            {
                isLoading = true;
                _lastWorkspaceId = Workspace.Id;
                await ChatService.JoinWorkspaceAsync(Workspace.Id);
                await CheckOwnership();
                await LoadChannels();
                await LoadMembers();
                
                ChannelDto? targetChannel = null;
                
                if (ActiveChannelId > 0)
                {
                    targetChannel = Channels.FirstOrDefault(c => c.Id == ActiveChannelId);
                }
                
                if (targetChannel == null && Channels.Any())
                {
                    targetChannel = Channels.FirstOrDefault(c => c.Type != ChannelType.Direct) ?? Channels.FirstOrDefault();
                }
                
                if (targetChannel != null)
                {
                    await SelectChannel(targetChannel);
                }
                else
                {
                    selectedChannelId = 0;
                }
                
                isLoading = false;
            }
            else if (ActiveChannelId != selectedChannelId && ActiveChannelId > 0)
            {
                selectedChannelId = ActiveChannelId;
            }
        }
    }

    private async Task CheckOwnership()
    {
       IsOwner = Workspace?.OwnerId == _currentUserId;
    }

    private async Task LoadChannels()
    {
        if (Workspace != null)
        {
            // Load workspace channels (DMs are excluded - they're only in the global DMs list)
            Channels = await ChannelService.GetChannelsAsync(Workspace.Id);
        }
    }

    private async Task LoadMembers()
    {
        if (Workspace != null)
        {
           Members = await WorkspaceService.GetWorkspaceMembersAsync(Workspace.Id);
        }
    }

    private async void HandleUserStatusChanged(UserStatusDto status)
    {
        var member = Members.FirstOrDefault(m => m.UserId == status.UserId);
        if (member != null)
        {
            member.Status = status.Status;
            await InvokeAsync(StateHasChanged);
        }
        else
        {
             _ = LoadMembers();
        }
    }

    private async Task SelectChannel(ChannelDto channel)
    {
        selectedChannelId = channel.Id;
        await OnChannelSelected.InvokeAsync(channel);
    }

    private async Task StartDM(UserStatusDto member)
    {
        if (member.UserId == _currentUserId) return;

        if (Workspace == null) return;
        
        // Check for existing global DM before creating a new one
        var globalDM = await ChannelService.CheckExistingGlobalDMAsync(member.UserId);
        
        if (globalDM != null && globalDM.Id > 0)
        {
            await SelectChannel(globalDM);
            return;
        }

        // No existing DM found, create a new one
        var channel = await ChannelService.StartDirectMessageAsync(Workspace.Id, member.UserId);
        
        if (channel != null)
        {
            await SelectChannel(channel);
        }
    }
    
    private string GetMemberStatus(string username)
    {
        var member = Members.FirstOrDefault(m => m.Username == username);
        return member?.Status.ToLower() ?? "offline";
    }

    private void OpenCreateModal()
    {
        CreateModal?.Open();
    }
    
    // OpenStartDMModal removed

    private void OpenWorkspaceSettings()
    {
        SettingsModal?.Open();
    }

    private async Task OnChannelCreated(ChannelDto newChannel)
    {
        // Check if exists
        if (!Channels.Any(c => c.Id == newChannel.Id))
        {
            Channels.Add(newChannel);
        }
        await SelectChannel(newChannel);
    }

    private async Task OnWorkspaceChanged()
    {
        await CheckOwnership();
        await LoadMembers();
        StateHasChanged();
    }

    public void Dispose()
    {
        ChatService.OnUserStatusChanged -= HandleUserStatusChanged;
    }
}
