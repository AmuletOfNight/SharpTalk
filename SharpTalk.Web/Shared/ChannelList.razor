@using SharpTalk.Shared.DTOs
@using SharpTalk.Web.Services
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@implements IDisposable
@inject ChannelService ChannelService
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Navigation
@inject ChatService ChatService
@inject WorkspaceService WorkspaceService
@inject UrlUtilityService UrlUtilityService

<div class="channel-list">
    <div class="workspace-name-header">
        <h5 title="@Workspace?.Name">@(Workspace?.Name ?? "Workspace")</h5>
        @if (IsOwner)
        {
            <div class="settings-trigger text-muted" title="Workspace Settings" @onclick="OpenWorkspaceSettings">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path
                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
                    </path>
                </svg>
            </div>
        }
    </div>

    <div class="sidebar-category">
        <h6>Channels</h6>
        @if (IsOwner)
        {
            <button class="btn btn-sm btn-link text-decoration-none p-0 text-muted" @onclick="OpenCreateModal"
            @onclick:stopPropagation="true" title="Create Channel">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            </button>
        }
    </div>

    <ul class="list-group list-group-flush mb-2">
        @if (isLoading)
        {
            @for (int i = 0; i < 5; i++)
            {
                <div class="skeleton skeleton-channel"></div>
            }
        }
        else
        {
            @foreach (var channel in Channels)
            {
                <li class="channel-item @(selectedChannelId == channel.Id ? "active" : "")"
            @onclick="() => SelectChannel(channel)">
                    <span class="channel-hash">#</span> @channel.Name
                </li>
            }
        }
    </ul>

    <div class="sidebar-category">
        <h6>Members</h6>
    </div>
    <ul class="list-group list-group-flush">
        @foreach (var member in Members)
        {
            <li class="channel-item d-flex align-items-center mb-1">
                <div class="member-avatar-wrapper">
                    <img src="@UrlUtilityService.GetAvatarUrl(member.AvatarUrl, "s")" 
                         class="member-avatar-list @(member.Status.ToLower())" 
                         alt="@member.Username" />
                </div>
                <span class="text-truncate">@member.Username</span>
            </li>
        }
    </ul>
</div>

<CreateChannelModal @ref="CreateModal" WorkspaceId="@(Workspace?.Id ?? 0)" OnChannelCreated="OnChannelCreated" />
<WorkspaceSettingsModal @ref="SettingsModal" Workspace="Workspace" IsOwner="IsOwner" OnWorkspaceChanged="OnWorkspaceChanged" />

@code {
    [Parameter]
    public WorkspaceDto? Workspace { get; set; }

    [Parameter]
    public int ActiveChannelId { get; set; }

    [Parameter]
    public EventCallback<ChannelDto> OnChannelSelected { get; set; }

    private List<ChannelDto> Channels = new List<ChannelDto>();
    private List<UserStatusDto> Members = new List<UserStatusDto>();
    private CreateChannelModal? CreateModal;
    private WorkspaceSettingsModal? SettingsModal;
    private int selectedChannelId;
    private bool IsOwner;
    private int _lastWorkspaceId;
    private bool isLoading;

    protected override async Task OnInitializedAsync()
    {
        ChatService.OnUserStatusChanged += HandleUserStatusChanged;
        await base.OnInitializedAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Workspace != null)
        {
            // If workspace changed, reload everything
            if (Workspace.Id != _lastWorkspaceId)
            {
                isLoading = true;
                _lastWorkspaceId = Workspace.Id;
                await ChatService.JoinWorkspaceAsync(Workspace.Id);
                await CheckOwnership();
                await LoadChannels();
                await LoadMembers();
                
                // Select channel logic:
                // 1. If ActiveChannelId is valid for this workspace, use it.
                // 2. Else if we have channels, default to first.
                // 3. Else none.
                
                ChannelDto? targetChannel = null;
                
                if (ActiveChannelId > 0)
                {
                    targetChannel = Channels.FirstOrDefault(c => c.Id == ActiveChannelId);
                }
                
                if (targetChannel == null && Channels.Any())
                {
                    targetChannel = Channels.First();
                }
                
                if (targetChannel != null)
                {
                    await SelectChannel(targetChannel);
                }
                else
                {
                    selectedChannelId = 0;
                }
                
                isLoading = false;
            }
            else if (ActiveChannelId != selectedChannelId && ActiveChannelId > 0)
            {
                // If just switching channels via parent (e.g. from somewhere else not sidebar?), sync UI
                // But usually ChannelList drives the parent. 
                // However if we want to support external navigation, we update here.
                selectedChannelId = ActiveChannelId;
            }
        }
    }

    private async Task CheckOwnership()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userIdStr = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        if (int.TryParse(userIdStr, out int userId))
        {
            IsOwner = Workspace?.OwnerId == userId;
        }
    }

    private async Task LoadChannels()
    {
        if (Workspace != null)
        {
            Channels = await ChannelService.GetChannelsAsync(Workspace.Id);
        }
    }

    private async Task LoadMembers()
    {
        if (Workspace != null)
        {
            Members = await WorkspaceService.GetWorkspaceMembersAsync(Workspace.Id);
        }
    }

    private async void HandleUserStatusChanged(UserStatusDto status)
    {
        var member = Members.FirstOrDefault(m => m.UserId == status.UserId);
        if (member != null)
        {
            member.Status = status.Status;
            await InvokeAsync(StateHasChanged);
        }
        else
        {
            // If user just joined or we didn't have them, refresh list?
            // Actually, if they are in the workspace but not in the initial list, they might be new.
            // For now, let's just refresh if they are not found.
            _ = LoadMembers();
        }
    }

    private async Task SelectChannel(ChannelDto channel)
    {
        selectedChannelId = channel.Id;
        await OnChannelSelected.InvokeAsync(channel);
    }

    private void OpenCreateModal()
    {
        CreateModal?.Open();
    }

    private void OpenWorkspaceSettings()
    {
        SettingsModal?.Open();
    }

    private async Task OnChannelCreated(ChannelDto newChannel)
    {
        Channels.Add(newChannel);
        await SelectChannel(newChannel);
    }

    private async Task OnWorkspaceChanged()
    {
        // Reload workspace data when it changes (rename, ownership transfer, etc.)
        await CheckOwnership();
        await LoadMembers();
        StateHasChanged();
    }

    public void Dispose()
    {
        ChatService.OnUserStatusChanged -= HandleUserStatusChanged;
    }
}
