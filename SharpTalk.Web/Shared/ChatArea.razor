@using SharpTalk.Shared.DTOs
@using SharpTalk.Web.Services
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@implements IAsyncDisposable
@inject ChatService ChatService
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime

<div class="chat-area">
    <div class="messages-list" id="messagesList">
        @foreach (var msg in Messages)
        {
            var isMine = msg.UserId == currentUserId;
            <div class='message-item @(isMine ? "message-mine" : "message-others")'>
                <div class="message-info">
                    <span class="message-author">@msg.Username</span>
                    <span class="message-timestamp">@msg.Timestamp.ToLocalTime().ToString("t")</span>
                </div>
                <div class="bubble-container">
                    <div class="message-content">@msg.Content</div>
                </div>
            </div>
        }
    </div>

    <div class="typing-indicator">
        @if (TypingUsers.Any())
        {
            <small class="text-muted italic">
                @(string.Join(", ", TypingUsers.Values)) @(TypingUsers.Count == 1 ? "is" : "are") typing...
            </small>
        }
    </div>

    <div class="message-input">
        <form @onsubmit="SendMessage">
            <input type="text" class="form-control" placeholder="Message #Channel" @bind="newMessage"
                @bind:event="oninput" />
        </form>
    </div>
</div>

@code {
    [Parameter]
    public int ChannelId { get; set; }

    private List<MessageDto> Messages = new List<MessageDto>();
    private string _newMessage = string.Empty;
    private string newMessage
    {
        get => _newMessage;
        set
        {
            if (_newMessage != value)
            {
                _newMessage = value;
                HandleTyping();
            }
        }
    }
    private int _currentChannelId;
    private int currentUserId;
    private Dictionary<int, string> TypingUsers = new Dictionary<int, string>();
    private System.Timers.Timer? typingTimer;
    private bool isTypingSent = false;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userIdStr = authState.User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
        int.TryParse(userIdStr, out currentUserId);

        ChatService.OnMessageReceived += HandleMessageReceived;
        ChatService.OnUserTyping += HandleUserTyping;
        await ChatService.InitializeAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (ChannelId != _currentChannelId)
        {
            if (_currentChannelId > 0)
            {
                await ChatService.LeaveChannelAsync(_currentChannelId);
            }

            _currentChannelId = ChannelId;
            Messages.Clear();

            // Load history
            var history = await ChatService.GetMessageHistoryAsync(ChannelId);
            Messages.AddRange(history);
            StateHasChanged();

            await ChatService.JoinChannelAsync(ChannelId);
        }
    }

    private async void HandleMessageReceived(MessageDto message)
    {
        if (message.ChannelId == ChannelId)
        {
            Messages.Add(message);
            // Clear typing indicator for this user if it exists
            if (TypingUsers.ContainsKey(message.UserId))
            {
                TypingUsers.Remove(message.UserId);
            }
            await InvokeAsync(StateHasChanged);
        }
    }

    private async void HandleUserTyping(int channelId, int userId, string username, bool isTyping)
    {
        if (channelId == ChannelId)
        {
            if (isTyping)
            {
                if (!TypingUsers.ContainsKey(userId))
                {
                    TypingUsers[userId] = username;
                }
            }
            else
            {
                TypingUsers.Remove(userId);
            }
            await InvokeAsync(StateHasChanged);
        }
    }

    private void HandleTyping()
    {
        if (string.IsNullOrWhiteSpace(newMessage)) return;

        if (!isTypingSent)
        {
            isTypingSent = true;
            _ = ChatService.SendTypingIndicatorAsync(ChannelId, true);
        }

        if (typingTimer == null)
        {
            typingTimer = new System.Timers.Timer(3000);
            typingTimer.AutoReset = false;
            typingTimer.Elapsed += async (s, args) =>
            {
                isTypingSent = false;
                await ChatService.SendTypingIndicatorAsync(ChannelId, false);
                await InvokeAsync(StateHasChanged);
            };
        }
        else
        {
            typingTimer.Stop();
        }
        typingTimer.Start();
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(newMessage))
        {
            var content = newMessage;
            newMessage = string.Empty;
            isTypingSent = false;
            typingTimer?.Stop();

            await ChatService.SendMessageAsync(ChannelId, content);
            await ChatService.SendTypingIndicatorAsync(ChannelId, false);
        }
    }

    public async ValueTask DisposeAsync()
    {
        ChatService.OnMessageReceived -= HandleMessageReceived;
        ChatService.OnUserTyping -= HandleUserTyping;
        typingTimer?.Dispose();
        if (_currentChannelId > 0)
        {
            await ChatService.LeaveChannelAsync(_currentChannelId);
        }
    }
}
