@using SharpTalk.Shared.DTOs
@using SharpTalk.Web.Services
@inject UserService UserService
@inject UrlUtilityService UrlUtilityService
@inject IJSRuntime JSRuntime

<div class="user-profile-container">
    <div class="user-profile"
         @onclick="HandleClick"
         @ref="userProfileElement">
        <div class="user-avatar-wrapper">
            <img src="@UrlUtilityService.GetAvatarUrl(CurrentUser?.AvatarUrl, "m")"
                 class="user-avatar @(CurrentUser?.Status?.ToLower() ?? "offline")"
                 alt="@CurrentUser?.Username" />
        </div>
        <div class="user-info">
            <span class="username">@CurrentUser?.Username</span>
            <span class="status-text">@GetStatusText()</span>
        </div>
        <span class="dropdown-arrow @(IsDropdownOpen ? "open" : "")">‚ñº</span>
    </div>

    @if (IsDropdownOpen)
    {
        <div class="user-dropdown @(IsDropdownVisible ? "visible" : "")" @onclick:stopPropagation>
            <button class="dropdown-item" @onclick="OpenSettings">
                <span class="icon">‚öôÔ∏è</span> Settings
            </button>
            <button class="dropdown-item" @onclick="Logout">
                <span class="icon">üö™</span> Logout
            </button>
        </div>
    }
</div>

<UserSettingsModal @ref="SettingsModal" />

@code {
    private UserInfo? CurrentUser;
    private bool IsDropdownOpen = false;
    private bool IsDropdownVisible = false;
    private UserSettingsModal? SettingsModal;
    private ElementReference userProfileElement;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfo();
        UserService.OnUserInfoChanged += HandleUserInfoChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await JSRuntime.InvokeVoidAsync("setupUserProfileGestures", userProfileElement);
        }
    }

    private async Task LoadUserInfo()
    {
        CurrentUser = await UserService.GetCurrentUserAsync();
        StateHasChanged();
    }

    private void HandleUserInfoChanged(UserInfo? userInfo)
    {
        CurrentUser = userInfo;
        StateHasChanged();
    }

    private void HandleClick()
    {
        ToggleDropdown();
    }

    private void ToggleDropdown()
    {
        if (IsDropdownOpen)
        {
            // Close dropdown
            IsDropdownVisible = false;
            Task.Delay(300).ContinueWith(_ =>
            {
                IsDropdownOpen = false;
                InvokeAsync(StateHasChanged);
            });
        }
        else
        {
            // Open dropdown
            IsDropdownOpen = true;
            StateHasChanged();
            Task.Delay(10).ContinueWith(_ =>
            {
                IsDropdownVisible = true;
                InvokeAsync(StateHasChanged);
            });
        }
    }

    private void OpenSettings()
    {
        IsDropdownOpen = false;
        IsDropdownVisible = false;
        SettingsModal?.Open();
    }

    private async Task Logout()
    {
        IsDropdownOpen = false;
        IsDropdownVisible = false;
        await UserService.LogoutAsync();
    }

    private string GetStatusText()
    {
        return CurrentUser?.Status switch
        {
            "Online" => "Online",
            "Away" => "Away",
            "Offline" => "Offline",
            _ => "Online"
        };
    }

    public void Dispose()
    {
        UserService.OnUserInfoChanged -= HandleUserInfoChanged;
    }
}
