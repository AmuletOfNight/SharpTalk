@using SharpTalk.Shared.DTOs
@using SharpTalk.Web.Services
@inject UserService UserService
@inject WorkspaceService WorkspaceService
@inject UrlUtilityService UrlUtilityService
@using SharpTalk.Web.Components.User
@inject IJSRuntime JSRuntime
@implements IDisposable

<div class="user-profile-container">
    <div class="user-profile" @onclick="HandleClick" @ref="userProfileElement">
        <div class="user-avatar-wrapper">
            <img src="@UrlUtilityService.GetAvatarUrl(CurrentUser?.AvatarUrl, "m")"
                class="user-avatar @(CurrentUser?.Status?.ToLower() ?? "offline")" alt="@CurrentUser?.Username" />
        </div>
        <div class="user-info">
            <span class="username">@CurrentUser?.Username</span>
            <span class="status-text">@GetStatusText()</span>
        </div>
        <span class="dropdown-arrow @(IsDropdownOpen ? "open" : "")">‚ñº</span>
        @if (HasPendingInvitations)
        {
            <span class="notification-dot"></span>
        }
    </div>

    @if (IsDropdownOpen)
    {
        <div class="user-dropdown @(IsDropdownVisible ? "visible" : "")" @onclick:stopPropagation>
            <button class="dropdown-item" @onclick="OpenSettings">
                <span class="icon">‚öôÔ∏è</span> Settings
            </button>
            <button class="dropdown-item" @onclick="Logout">
                <span class="icon">üö™</span> Logout
            </button>
            <div class="dropdown-divider"></div>
            <button class="dropdown-item" @onclick="OpenPendingInvitations">
                <span class="icon">üì©</span> Invitations
                @if (HasPendingInvitations)
                {
                    <span class="badge bg-danger ms-auto">@PendingInvitationCount</span>
                }
            </button>
        </div>
    }
</div>

<UserSettingsModal @ref="SettingsModal" />

@if (ShowPendingInvitationsModal)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Pending Invitations</h5>
                    <button type="button" class="btn-close" @onclick="ClosePendingInvitationsModal"></button>
                </div>
                <div class="modal-body">
                    <PendingInvitations />
                </div>
            </div>
        </div>
    </div>
}

@code {
    private UserInfo? CurrentUser;
    private bool IsDropdownOpen = false;
    private bool IsDropdownVisible = false;
    private UserSettingsModal? SettingsModal;
    private ElementReference userProfileElement;
    private DotNetObjectReference<UserProfile>? objRef;

    private bool ShowPendingInvitationsModal = false;
    private int PendingInvitationCount = 0;
    private bool HasPendingInvitations => PendingInvitationCount > 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadUserInfo();
        await CheckPendingInvitations();
        UserService.OnUserInfoChanged += HandleUserInfoChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("setupUserProfileGestures", userProfileElement, objRef);
        }
    }

    private async Task LoadUserInfo()
    {
        CurrentUser = await UserService.GetCurrentUserAsync();
        StateHasChanged();
    }

    private void HandleUserInfoChanged(UserInfo? userInfo)
    {
        CurrentUser = userInfo;
        StateHasChanged();
    }

    private void HandleClick()
    {
        ToggleDropdown();
    }

    private void ToggleDropdown()
    {
        if (IsDropdownOpen)
        {
            // Close dropdown
            IsDropdownVisible = false;
            Task.Delay(300).ContinueWith(_ =>
            {
                IsDropdownOpen = false;
                InvokeAsync(StateHasChanged);
            });
        }
        else
        {
            // Open dropdown
            IsDropdownOpen = true;
            StateHasChanged();
            Task.Delay(10).ContinueWith(_ =>
            {
                IsDropdownVisible = true;
                InvokeAsync(StateHasChanged);
            });
        }
    }

    private void OpenSettings()
    {
        CloseDropdown();
        SettingsModal?.Open();
    }

    [JSInvokable]
    public void CloseDropdown()
    {
        IsDropdownVisible = false;
        IsDropdownOpen = false;
        StateHasChanged();
    }

    private async Task Logout()
    {
        IsDropdownOpen = false;
        IsDropdownVisible = false;
        await UserService.LogoutAsync();
    }

    private string GetStatusText()
    {
        return CurrentUser?.Status switch
        {
            "Online" => "Online",
            "Away" => "Away",
            "Offline" => "Offline",
            _ => "Online"
        };
    }

    public void Dispose()
    {
        UserService.OnUserInfoChanged -= HandleUserInfoChanged;
        objRef?.Dispose();
    }
    private async Task CheckPendingInvitations()
    {
        var invites = await WorkspaceService.GetMyInvitationsAsync();
        PendingInvitationCount = invites.Count;
        StateHasChanged();
    }

    private void OpenPendingInvitations()
    {
        IsDropdownOpen = false;
        IsDropdownVisible = false;
        ShowPendingInvitationsModal = true;
    }

    private void ClosePendingInvitationsModal()
    {
        ShowPendingInvitationsModal = false;
        // Refresh count after closing
        _ = CheckPendingInvitations();
    }
}
