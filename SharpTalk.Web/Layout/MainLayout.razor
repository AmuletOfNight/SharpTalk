@using SharpTalk.Shared.DTOs
@using SharpTalk.Web.Services
@using SharpTalk.Web.Shared
@inherits LayoutComponentBase
@implements IDisposable

<div class="page @(isMobile ? "is-mobile" : "is-desktop")">
    @if (IsAuthenticated)
    {
        @if (isMobile)
        {
            <MobileNavigation CurrentView="currentMobileView" OnBack="GoBack" OnMenuToggle="ToggleMenu" CurrentChannel="CurrentChannel" CurrentWorkspace="CurrentWorkspace" />
        }

        <div class="sidebar @(isMobile && currentMobileView == MobileView.WorkspaceList ? "mobile-visible" : "")">
            <div class="sidebar-content">
                @if (IsLoading)
                {
                    <div class="workspace-list p-2">
                        @for (int i = 0; i < 5; i++)
                        {
                            <div class="skeleton skeleton-icon"></div>
                        }
                    </div>
                }
                else
                {
                    <Sidebar Workspaces="Workspaces" 
                             ActiveWorkspaceId="ActiveWorkspaceId"
                             OnWorkspaceSelected="HandleWorkspaceSelected" 
                             OnWorkspacesReordered="HandleWorkspacesReordered"
                             OnWorkspaceCreatedCallback="HandleWorkspaceCreated" />
                }
            </div>
        </div>
        @if (!isMobile || currentMobileView != MobileView.ChatArea)
        {
            <UserProfile />
        }

    <WorkspaceSettingsModal @ref="WorkspaceSettingsModalRef" Workspace="CurrentWorkspace" IsOwner="IsWorkspaceOwner" OnWorkspaceChanged="HandleWorkspaceChanged" />

        @if (IsLoading)
        {
            <div class="channel-sidebar @(isMobile && currentMobileView == MobileView.ChannelList ? "mobile-visible" : "")">
                <div class="workspace-name-header">
                    <div class="skeleton skeleton-title"></div>
                </div>
                <div class="p-3">
                    <div class="skeleton skeleton-text mb-4"></div>
                    @for (int i = 0; i < 6; i++)
                    {
                        <div class="skeleton skeleton-channel"></div>
                    }
                </div>
            </div>
        }
        else if (ActiveWorkspaceId == -2)
        {
            <div class="channel-sidebar @(isMobile && currentMobileView == MobileView.ChannelList ? "mobile-visible" : "")">
                <DirectMessagesList ActiveChannelId="@(CurrentChannel?.Id ?? 0)"
                                    OnChannelSelected="HandleChannelSelected" />
            </div>
        }
        else if (CurrentWorkspace != null)
        {
            <div class="channel-sidebar @(isMobile && currentMobileView == MobileView.ChannelList ? "mobile-visible" : "")">
                <ChannelList Workspace="CurrentWorkspace"
                             ActiveChannelId="@(CurrentChannel?.Id ?? 0)"
                             OnChannelSelected="HandleChannelSelected" />
            </div>
        }

        <main class="@(isMobile && currentMobileView == MobileView.ChatArea ? "mobile-visible" : "")">
            <article class="content">
                @if (IsLoading)
                {
                    <div class="chat-area">
                        <div class="messages-list">
                            @for (int i = 0; i < 4; i++)
                            {
                                <div class="skeleton skeleton-message mb-3"
                        style="width: @(i % 2 == 0 ? "60%" : "40%"); align-self: @(i % 2 == 0 ? "flex-start" : "flex-end")">
                                </div>
                            }
                        </div>
                    </div>
                }
                else if (CurrentChannel != null)
                {
                    <ChatArea Channel="CurrentChannel" />
                }
                else if (ActiveWorkspaceId == -2 && CurrentChannel == null)
                {
                    <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                        <div class="text-center">
                            <h4>Direct Messages</h4>
                            <p>Select a conversation to start chatting</p>
                        </div>
                    </div>
                }
                else
                {
                    @Body
                }
            </article>
        </main>
    }
    else
    {
        <main class="mobile-visible">
            @Body
        </main>
    }
</div>

@inject ChatService ChatService
@inject AuthenticationStateProvider AuthStateProvider
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@inject WorkspaceService WorkspaceService
@inject UserService UserService
@inject IJSRuntime JSRuntime

@code {
    private List<WorkspaceDto>? Workspaces;
    private WorkspaceDto? CurrentWorkspace;
    private ChannelDto? CurrentChannel;
    private bool IsLoading = true;
    private bool IsAuthenticated = false;
    private int ActiveWorkspaceId = -1;
    private MobileView currentMobileView = MobileView.WorkspaceList;
    private bool isMobile = false;
    private DotNetObjectReference<MainLayout>? objRef;
    private WorkspaceSettingsModal? WorkspaceSettingsModalRef;
    private bool IsWorkspaceOwner => CurrentWorkspace?.OwnerId == UserService.CurrentUser?.Id;

    protected override async Task OnInitializedAsync()
    {
        AuthStateProvider.AuthenticationStateChanged += HandleAuthenticationStateChanged;

        try
        {
            await InitializeChatServiceAsync();
        }
        finally
        {
            IsLoading = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("registerMobileViewCallback", objRef);
            await CheckMobileView();
        }
    }

    [JSInvokable]
    public async Task OnMobileViewChanged(bool mobile)
    {
        if (isMobile != mobile)
        {
            isMobile = mobile;
            if (isMobile)
            {
                // Determine best initial view when switching to mobile
                if (CurrentChannel != null) currentMobileView = MobileView.ChatArea;
                else if (CurrentWorkspace != null || ActiveWorkspaceId == -2) currentMobileView = MobileView.ChannelList;
                else currentMobileView = MobileView.WorkspaceList;
            }
            await InvokeAsync(StateHasChanged);
        }
    }

    private async void HandleAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        await InvokeAsync(async () =>
        {
            await InitializeChatServiceAsync();
            StateHasChanged();
        });
    }

    private async Task InitializeChatServiceAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        IsAuthenticated = authState.User.Identity?.IsAuthenticated == true;

        if (IsAuthenticated)
        {
            await ChatService.InitializeAsync();
            await LoadDataAsync();
        }
    }

    private async Task LoadDataAsync()
    {
        try
        {
            Workspaces = await WorkspaceService.GetMyWorkspacesAsync();
            var user = await UserService.GetCurrentUserAsync();
            
            if (user != null && user.StartOnHome)
            {
                // Start on Home logic
                await HandleWorkspaceSelected(-1);
            }
            else
            {
                // Retrieve last state
                var lastWorkspaceId = await LocalStorage.GetItemAsync<int?>("lastWorkspaceId");
                
                if (lastWorkspaceId.HasValue && Workspaces.Any(w => w.Id == lastWorkspaceId.Value))
                {
                    await HandleWorkspaceSelected(lastWorkspaceId.Value);
                }
                else if (Workspaces.Any())
                {
                    // Default to first if no history or history invalid
                    await HandleWorkspaceSelected(Workspaces.First().Id);
                }
                else
                {
                     // No workspaces, go home
                     await HandleWorkspaceSelected(-1);
                }
            }
        }
        catch (Exception ex)
        {
             // Log the error for debugging
             Console.WriteLine($"Error loading data: {ex.Message}");
             // Still set IsLoading to false so we can see something
        }
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= HandleAuthenticationStateChanged;
        objRef?.Dispose();
    }

    private async Task HandleWorkspaceSelected(int workspaceId)
    {
        ActiveWorkspaceId = workspaceId;
        
        if (workspaceId == -1 || workspaceId == -2)
        {
            CurrentWorkspace = null;
            CurrentChannel = null;
            await LocalStorage.RemoveItemAsync("lastWorkspaceId");
        }
        else
        {
             CurrentWorkspace = Workspaces?.FirstOrDefault(w => w.Id == workspaceId);
             if (CurrentWorkspace != null)
             {
                 await LocalStorage.SetItemAsync("lastWorkspaceId", workspaceId);
                  
                 // Handle AutoOpenLastChannel
                 var user = UserService.CurrentUser;
                 if (user != null && user.AutoOpenLastChannel)
                 {
                     var lastChannelId = await LocalStorage.GetItemAsync<int?>($"workspace_{workspaceId}_lastChannel");
                     
                     if (lastChannelId.HasValue)
                     {
                         var channels = await WorkspaceService.GetWorkspaceChannelsAsync(workspaceId);
                         var channel = channels.FirstOrDefault(c => c.Id == lastChannelId.Value);
                         if (channel != null)
                         {
                             CurrentChannel = channel;
                         }
                         else
                         {
                             var general = channels.FirstOrDefault(c => c.Name == "general");
                             CurrentChannel = general;
                         }
                     }
                     else
                     {
                         var channels = await WorkspaceService.GetWorkspaceChannelsAsync(workspaceId);
                         CurrentChannel = channels.FirstOrDefault(c => c.Name == "general");
                     }
                 }
                 else
                 {
                     CurrentChannel = null;
                 }
             }
        }
        
        // Mobile: Navigate to channel list when workspace is selected
        if (isMobile)
        {
            if (workspaceId > 0 || workspaceId == -2)
            {
                SetMobileView(MobileView.ChannelList);
            }
            else if (workspaceId == -1)
            {
                SetMobileView(MobileView.ChatArea);
            }
        }
        
        StateHasChanged();
    }
    
    private async void HandleChannelSelected(ChannelDto channel)
    {
        if (channel.WorkspaceId == null)
        {
            // Global DM
            ActiveWorkspaceId = -2;
            CurrentWorkspace = null;
            await LocalStorage.RemoveItemAsync("lastWorkspaceId");
        }
        
        CurrentChannel = channel;
        
        if (CurrentWorkspace != null)
        {
            await LocalStorage.SetItemAsync($"workspace_{CurrentWorkspace.Id}_lastChannel", channel.Id);
        }
        
        // Mobile: Navigate to chat area when channel is selected
        if (isMobile)
        {
            SetMobileView(MobileView.ChatArea);
        }
        
        StateHasChanged();
    }
    
    private async Task HandleWorkspacesReordered(List<WorkspaceDto> reorderedWorkspaces)
    {
        Workspaces = reorderedWorkspaces;
        var ids = Workspaces.Select(w => w.Id).ToList();
        await WorkspaceService.ReorderWorkspacesAsync(ids);
    }
    
    private async Task HandleWorkspaceCreated(WorkspaceDto newWorkspace)
    {
        if (Workspaces == null) Workspaces = new List<WorkspaceDto>();
        Workspaces.Add(newWorkspace);
        await HandleWorkspaceSelected(newWorkspace.Id); // Auto switch
    }

    private async Task CheckMobileView()
    {
        var mobileView = await JSRuntime.InvokeAsync<bool>("isMobile");
        if (mobileView != isMobile)
        {
            isMobile = mobileView;
            if (isMobile)
            {
                if (CurrentChannel != null) currentMobileView = MobileView.ChatArea;
                else if (CurrentWorkspace != null || ActiveWorkspaceId == -2) currentMobileView = MobileView.ChannelList;
                else currentMobileView = MobileView.WorkspaceList;
            }
            StateHasChanged();
        }
    }

    private void SetMobileView(MobileView view)
    {
        currentMobileView = view;
        StateHasChanged();
    }

    private void GoBack()
    {
        switch (currentMobileView)
        {
            case MobileView.ChatArea:
                SetMobileView(MobileView.ChannelList);
                break;
            case MobileView.ChannelList:
                SetMobileView(MobileView.WorkspaceList);
                break;
        }
    }

    private void ToggleMenu()
    {
        switch (currentMobileView)
        {
            case MobileView.WorkspaceList:
                // Already on workspace list, do nothing
                break;
            case MobileView.ChannelList:
                // Open workspace settings modal
                WorkspaceSettingsModalRef?.Open();
                break;
            case MobileView.ChatArea:
                SetMobileView(MobileView.ChannelList);
                break;
        }
    }

    private async Task HandleWorkspaceChanged()
    {
        // Reload workspace data when settings change
        if (CurrentWorkspace != null)
        {
            var updatedWorkspace = await WorkspaceService.GetWorkspaceByIdAsync(CurrentWorkspace.Id);
            if (updatedWorkspace != null)
            {
                CurrentWorkspace = updatedWorkspace;
                StateHasChanged();
            }
        }
    }
}
