@using SharpTalk.Shared.DTOs
@using SharpTalk.Web.Services
@using SharpTalk.Web.Shared
@inherits LayoutComponentBase
@implements IDisposable

<div class="page">
    @if (IsAuthenticated)
    {
        <div class="sidebar">
            <div class="sidebar-content">
                @if (IsLoading)
                {
                    <div class="workspace-list p-2">
                        @for (int i = 0; i < 5; i++)
                        {
                            <div class="skeleton skeleton-icon"></div>
                        }
                    </div>
                }
                else
                {
                    <Sidebar OnWorkspaceSelected="HandleWorkspaceSelected" />
                }
            </div>
        </div>
        <UserProfile />

        @if (IsLoading)
        {
            <div class="channel-sidebar">
                <div class="workspace-name-header">
                    <div class="skeleton skeleton-title"></div>
                </div>
                <div class="p-3">
                    <div class="skeleton skeleton-text mb-4"></div>
                    @for (int i = 0; i < 6; i++)
                    {
                        <div class="skeleton skeleton-channel"></div>
                    }
                </div>
            </div>
        }
        else if (CurrentWorkspace != null)
        {
            <div class="channel-sidebar">
                <ChannelList Workspace="CurrentWorkspace" OnChannelSelected="HandleChannelSelected" />
            </div>
        }

        <main>
            <article class="content px-4">
                @if (IsLoading)
                {
                    <div class="chat-area">
                        <div class="messages-list">
                            @for (int i = 0; i < 4; i++)
                            {
                                <div class="skeleton skeleton-message mb-3"
                        style="width: @(i % 2 == 0 ? "60%" : "40%"); align-self: @(i % 2 == 0 ? "flex-start" : "flex-end")">
                                </div>
                            }
                        </div>
                    </div>
                }
                else if (CurrentChannel != null)
                {
                    <ChatArea Channel="CurrentChannel" />
                }
                else
                {
                    @Body
                }
            </article>
        </main>
    }
    else
    {
        <main>
            @Body
        </main>
    }
</div>

@inject ChatService ChatService
@inject AuthenticationStateProvider AuthStateProvider

@code {
    private WorkspaceDto? CurrentWorkspace;
    private ChannelDto? CurrentChannel;
    private bool IsLoading = true;
    private bool IsAuthenticated = false;

    protected override async Task OnInitializedAsync()
    {
        AuthStateProvider.AuthenticationStateChanged += HandleAuthenticationStateChanged;

        try
        {
            await InitializeChatServiceAsync();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async void HandleAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        await InvokeAsync(async () =>
        {
            await InitializeChatServiceAsync();
            StateHasChanged();
        });
    }

    private async Task InitializeChatServiceAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        IsAuthenticated = authState.User.Identity?.IsAuthenticated == true;

        if (IsAuthenticated)
        {
            await ChatService.InitializeAsync();
        }
    }

    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= HandleAuthenticationStateChanged;
    }

    private void HandleWorkspaceSelected(WorkspaceDto workspace)
    {
        CurrentWorkspace = workspace;
        CurrentChannel = null; // Reset channel when workspace changes
        StateHasChanged();
    }

    private void HandleChannelSelected(ChannelDto channel)
    {
        CurrentChannel = channel;
        StateHasChanged();
    }
}
